#!/usr/bin/env bash

readonly EXIT_SUCCESS=0
readonly EXIT_FAILURE=1

print_help() {
  local sname=$(echo "$0" | sed 's/.*\///')

cat <<EOF
By: uriid1
  Version: $version
  Blocking IP addresses of domains using iptables.

Usage:
  $sname [OPTIONS]

Options:
  --domains, -d    List of domains
  --chains, -Ñ     List of chains
  --interface, -i  Interface (Default: found first en*)

Example:
  $sname --domains site-one.com site-two.com --interface enp7s0 --chains FORWARD OUTPUT INPUT
EOF
}

if [ $# -eq 0 ]; then
  print_help
  exit $EXIT_FAILURE
fi

case "$1" in
  --help | -h)
    print_help
    exit $EXIT_SUCCESS
  ;;
esac

__interface=$(ip -j link show | jq -r '.[] | select(.ifname | test("^en")) | .ifname')
__chains=()
__domains=()

while [[ "$#" -gt 0 ]]; do
  case "$1" in
    --domains | -d)
      shift
      while [[ "$#" -gt 0 && "$1" != --* && "$1" != -* ]]; do
        __domains+=("$1")
        shift
      done
    ;;

    --chains | -c)
      shift
      while [[ "$#" -gt 0 && "$1" != --* && "$1" != -* ]]; do
        __chains+=("$1")
        shift
      done
    ;;

    --interface | -i)
      if [ -n "$2" ]; then
        __interface="$2"
        shift 2
      else
        echo "Missing argument for $1 option"
        exit $EXIT_FAILURE
      fi
    ;;

  *)
    shift
  ;;
  esac
done

sudo -v
for domain in "${__domains[@]}"; do
  IPS=$(dig +short $domain)
  for IP in $IPS; do
    if [[ $IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+ ]]; then
      for chain in "${__chains[@]}"; do
        echo "Blocked: domain: $domain Ip: $IP Chain: $chain"
        case $chain in
          "FORWARD" | "forward")
            sudo iptables -A FORWARD -i $__interface -d $IP -j REJECT
          ;;
          "OUTPUT" | "output")
            sudo iptables -A OUTPUT -o $__interface -d $IP -j REJECT
          ;;
          "INPUT" | "input")
            sudo iptables -A INPUT -i $__interface -s $IP -j REJECT
          ;;
        esac
      done
    fi
  done
done
sudo -k
